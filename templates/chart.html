{% extends 'base.html' %}

{% block head %}

<title>Chart</title>
<link rel="stylesheet" href="static/css/sensors.css">

{% endblock %}

{% block body %}
    <h1>Experimental Chart Pond {{pond_id}}</h1>
    <div class="combobox-container"></div>
        <label for="starDate" class="combobox-label">Start </label>
        <input type="datetime-local" id="startDate" name="start" onchange="handleDates()">
        <label for="endDate" class="combobox-label">End </label>
        <input type="datetime-local" id="endDate" name="end">
    </div>
    <div class="chartContainer">
        <canvas id="doChart"></canvas>
    </div>
    <div class="chartContainer">
        <canvas id="temperatureChart"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.2/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@0.2.0"></script>
    <script src="{{ url_for('static', filename='js/helper.js') }}"></script>
    <script>
        function handleDates(){
            let start = luxon.DateTime.fromISO(document.getElementById('startDate').value, {"zone":"US/Central"});
            let end = luxon.DateTime.fromISO(document.getElementById('endDate').value, {"zone":"US/Central"});
            start = start.setZone("UTC");
            end = end.setZone("UTC");
            const startString = start.toFormat("yyyyMMdd_HH:mm:ss", {"zone":"UTC"});
            const endString = end.toFormat("yyyyMMdd_HH:mm:ss", {"zone":"UTC"});
            fetchAndDisplay(startString, endString);
        }
    </script>
  <script>

    function prep_data(data) {
        for (var key in data){
            const do_mgl = convert_to_mgl(100 * data[key]['do'].at(-1)/data[key]['init_do'], data[key]['temp'].at(-1), data[key]['init_pressure'], 0);
            const temp_f = 32 + (data[key]['temp'].at(-1) * 9/5);
            data[key]['do_mgl'] = do_mgl;
            data[key]['temp_f'] = temp_f;
            data[key]['time_ms'] = luxon.DateTime.fromFormat(key, "yyyyMMdd_HH:mm:ss", {"zone":"UTC"});
        };
        return data;
    };

    function generate_graph(myChart, data, id, ylabel){
        if (myChart){
            myChart.destroy();
        };

        let hourFormat = 'MM/dd hh:mm a';
        if (window.screen.width < 500 || window.screen.height < 500)
            hourFormat = 'hh a';

        myChart = new Chart(id, {
            type: 'scatter',
            data: data,
            options: {
                responsive:true,
                maintainAspectRatio:false,
                scales:{
                    x:{
                        type:'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                            'hour': hourFormat
                            }
                        },
                        ticks:{
                            maxTicksLimit:10,
                        },
                        adapters:{
                            date: {
                                zone:"US/Central",
                            }
                        }
                    },
                    y:{
                      title:{
                        display:true,
                        text:ylabel,
                      }
                    },
                }
            },
        });
        return myChart;
    };

    async function fetchAndDisplay(start, end) {
        const pondId = {{ pond_id }};
        var res = await fetch('/dataTime/LH_Farm pond_' + pondId + ' ' + start + ' ' + end);
        var data = await res.json();
        data = await prep_data(data);
        //prepare do data
        var do_buoy = [];
        var do_truck = [];
        for (const key in data){
            const dp = {'x':data[key]['time_ms'].ts, 'y':data[key]['do_mgl']}
            if (data[key]['type'] == "buoy"){
                do_buoy.push(dp);
            }
            else if (data[key]['type'] == "truck"){
                do_truck.push(dp);
            }
        }
        //prepare temp _data
        var temp_buoy = [];
        var temp_truck = [];
        for (const key in data){
            const dp = {'x':data[key]['time_ms'].ts, 'y':data[key]['temp_f']}
            if (data[key]['type'] == "buoy"){
                temp_buoy.push(dp);
            }
            else if (data[key]['type'] == "truck"){
                temp_truck.push(dp);
            }
        }

        const data1 = {
            datasets: [
                {
                type: 'scatter',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                data: do_buoy,
                label:"buoy"
                },
                {
                type: 'scatter',
                borderColor: 'rgba(1, 120, 255, 1)',
                backgroundColor: 'rgba(1, 120, 255, 0.5)',
                data: do_truck,
                label:"truck"
                }
            ],
        };
        const data2 = {
            datasets: [
                {
                type: 'scatter',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                data: temp_buoy,
                label:"buoy"
                },
                {
                type: 'scatter',
                borderColor: 'rgba(1, 120, 255, 1)',
                backgroundColor: 'rgba(1, 120, 255, 0.5)',
                data: temp_truck,
                label:"truck"
                }
            ],
        };
        doChart = generate_graph(doChart, data1, 'doChart', 'DO (mg/l)');
        temperatureChart = generate_graph(temperatureChart, data2, 'temperatureChart', 'Temperature (F)');
    };
    document.getElementById('endDate').value= luxon.DateTime.now().toFormat("yyyy-MM-dd'T'HH:mm", {'zone':'US/Central'});
    document.getElementById('startDate').value= (luxon.DateTime.now().minus(1000 * 60 * 60 * 24 * 5)).toFormat("yyyy-MM-dd'T'HH:mm", {'zone':'US/Central'});
    let doChart = new Chart('doChart');
    let temperatureChart = new Chart('temperatureChart');
    handleDates();
  </script>

{% endblock %}